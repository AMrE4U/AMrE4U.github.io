<!DOCTYPE html>
<html lang="en">

<head>
	<title>Basic Scene with WebXR</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r126/three.js" crossorigin="anonymous"></script>
</head>

<body>
	<script type="module">
    // To start an AR scene with webXR, we can use a handy button provided by three.js
    // We first have to import it because it is a javascript module
    import { ARButton } from 'https://unpkg.com/three@0.126.0/examples/jsm/webxr/ARButton.js';

		let camera, scene, renderer;
    let sphere;

		init();
		animate();

		function init() {
			const container = document.createElement('div');
			document.body.appendChild(container);

			scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 40);

			renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
      // This next line is important to to enable the renderer for WebXR
			renderer.xr.enabled = true; // New!
			container.appendChild(renderer.domElement);

			// light
			const light = new THREE.DirectionalLight()
			light.position.set(1, 0, 0)
			scene.add(light)

			// globe
			sphere = new THREE.Mesh(
			  new THREE.SphereGeometry(.2, 50, 50),
			  // new THREE.ShaderMaterial({
			  //   vertexShader: document.getElementById( 'vertexShader' ).textContent,
			  //   fragmentShader: document.getElementById( 'fragmentShader' ).textContent,
			  //   uniforms: {
			  //     globeTexture: {
			  //       value: new THREE.TextureLoader().load('./img/globe.jpg')
			  //     }
			  //   }
			  // })
				new THREE.MeshStandardMaterial({
					map: new THREE.TextureLoader().load('./img/world.topo.bathy.200412.3.jpg'),
					bumpMap: new THREE.TextureLoader().load('./img/gebco_08_rev_elev.png'),
					bumpScale: 1
				})
			)
			sphere.position.set(0, 0, -0.5);
			scene.add(sphere)

			//atmosphere
			// const atmosphere = new THREE.Mesh(
			//   new THREE.SphereGeometry(.1, 50, 50),
			//   new THREE.ShaderMaterial({
			//     vertexShader: document.getElementById( 'atmosphereVert' ).textContent,
			//     fragmentShader: document.getElementById( 'atmosphereFrag' ).textContent,
			//     blending: THREE.AdditiveBlending,
			//     side: THREE.BackSide
			//   })
			// )
			// atmosphere.position.set(0, 0, -0.5);
			// atmosphere.scale.set(1.1, 1.1, 1.1)
			// scene.add(atmosphere)

			// Add the AR button to the body of the DOM
			document.body.appendChild(ARButton.createButton(renderer));

			window.addEventListener('resize', onWindowResize, false);
		}

		function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize(window.innerWidth, window.innerHeight);
		}

		function animate() {
			renderer.setAnimationLoop(render);
		}

		function render() {
			renderer.render(scene, camera);
			sphere.rotation.y += 0.002
		}

	</script>


	<script type="x-shader/x-vertex" id="vertexShader">
		varying vec2 vertexUV;
		varying vec3 vectorNormal;

		void main() {
			vertexUV = uv;
			vectorNormal = normalize(normalMatrix * normal);
			gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
		}
	</script>
	<script type="x-shader/x-fragment" id="fragmentShader">
		uniform sampler2D globeTexture;
		varying vec2 vertexUV;
		varying vec3 vectorNormal;

		void main() {
			float intensity = 1.05 - dot(vectorNormal, vec3(0.0, 0.0, 1.0));
			vec3 atmosphere = vec3(0.3, 0.6, 1.0) * pow(intensity, 1.5);

			gl_FragColor = vec4(atmosphere + texture2D(globeTexture, vertexUV).xyz, 1.0);
		}
	</script>
	<script type="x-shader/x-vertex" id="atmosphereVert">
		varying vec3 vectorNormal;

		void main() {
			vectorNormal = normalize(normalMatrix * normal);
			gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
		}
	</script>
	<script type="x-shader/x-fragment" id="atmosphereFrag">
		varying vec3 vectorNormal;

		void main() {
			float intensity = pow(0.8 - dot(vectorNormal, vec3(0,0,1.0)), 2.0);
			gl_FragColor = vec4(0.3, 0.6, 1.0, 1.0) * intensity;
		}
	</script>
</body>

</html>
